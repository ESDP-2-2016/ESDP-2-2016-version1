!function(t){"use strict";t.support.pushState=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);var i={init:function(i,o){o.options=t.extend({scrollContainer:window,scrollPadding:100,scrollEventDelay:300},i),this.options=o.options,this.container=o.container,o.scrollModule=this,this._toplock=!0,this._bottomlock=!0,this.scrollContainer=t(this.options.scrollContainer),this.updateEntities(),this.sortMarkers(),this.currentPage=null,this.container.on("jes:afterPageLoad",t.proxy(function(t,i,o){if(this.updateEntities(),this.sortMarkers(),this.checkMarker(),"top"==o){var n=this.markers[1].top,e=this.scrollContainer.scrollTop();this.scrollContainer.scrollTop(e+n)}},this)),this.bind()},updateEntities:function(){this.entities=t(this.options.entity,this.container)},sortMarkers:function(){var i=[];t(".jes-marker",this.container).each(function(){i.push({top:t(this).position().top,url:t(this).data("jesUrl")})}),this.markers=i},checkMarker:function(){for(var i=this.markers[0],o=this.scrollContainer.scrollTop(),n=1;n<this.markers.length&&o>this.markers[n].top;n++)i=this.markers[n];i.url!=this.currentPage&&(this.currentPage=i.url,t(this.container).trigger("jes:scrollToPage",i.url))},bind:function(){this.scrollContainer.on("scroll.jes",t.proxy(function(i){this._tId||(this.scrollHandler(i),this._tId=setTimeout(t.proxy(function(){this._tId=null},this),this.options.scrollEventDelay))},this))},unbind:function(){t(this.options.scrollContainer).off("scroll.jes")},scrollHandler:function(){var i=this.scrollContainer,o=this.entities,n=o.first(),e=o.last(),s=i.scrollTop(),r=i.height(),a=s+r,h=n.position().top,l=h+this.options.scrollPadding,c=e.outerHeight()+e.position().top,p=c-this.options.scrollPadding;s<l?this._toplock||(t(this.container).trigger("jes:topThreshold"),this._toplock=!0):this._toplock=!1,a>p?this._bottomlock||(t(this.container).trigger("jes:bottomThreshold"),this._bottomlock=!0):this._bottomlock=!1,this.checkMarker()}},o={init:function(i,o){o.options=t.extend({},i),this.options=o.options,this.container=o.container,this.setMarker(t(this.options.entity,this.container).first(),location.href),o.ajaxModule=this},loadPage:function(i,o,n){var e={top:{find:"first",inject:"insertBefore"},bottom:{find:"last",inject:"insertAfter"}},s=e[o];this.container.trigger("jes:beforePageLoad",[i,o]),t.get(i,null,t.proxy(function(e){var r=t("<div>").html(e),a=this.options.container,h=t(a,r).first();if(h.length){var l=h.find(this.options.entity);"bottom"==o&&l.each(function(){var i=t(this).attr("id");i&&t("#"+i,this.container).remove()});var c=t(this.options.entity,a)[s.find]();l[s.inject](c),this.setMarker(l.first(),i)}t.isFunction(n)&&n(r),this.container.trigger("jes:afterPageLoad",[i,o,r,l])},this),"html")},setMarker:function(t,i){t.addClass("jes-marker").data("jesUrl",i)}},n={init:function(i,o){o.options=t.extend({nextPage:".pagination a[rel=next]",previousPage:".pagination a[rel=previous]"},i),this.options=o.options,this.container=o.container,t.each([{selector:this.options.nextPage,event:"jes:bottomThreshold.navigation",placement:"bottom"},{selector:this.options.previousPage,event:"jes:topThreshold.navigation",placement:"top"}],t.proxy(function(i,n){if(n.element=t(n.selector),n.element.length){var e=n.element.prop("href"),s=!1,r=function(){!s&&e&&(s=!0,o.ajaxModule.loadPage(e,n.placement,t.proxy(function(i){var o=t(n.selector,t(i));o.length?(s=!1,e=o.prop("href"),n.element.attr("href",e)):(t(this).off(n.event),n.element.remove())},this)))};t(this.container).on(n.event,r),t(n.element).on("click",t.proxy(function(t){t.preventDefault(),r.apply(this.container)},this))}},this))}},e={init:function(i,o){t.support.pushState&&o.container.on("jes:scrollToPage",function(t,i){history.replaceState({},null,i)})}};t.endlessScroll=function(s){if(this.options=t.extend(!0,{container:"#container",entity:".entity",_modules:[o,i,n,e],modules:[]},s),this.container=t(this.options.container),!this.container.length)throw"Container for endless scroll isn't available on the page";return t.merge(this.options.modules,this.options._modules),this.options.modules.forEach(t.proxy(function(t){t.init(this.options,this)},this)),this}}(jQuery);